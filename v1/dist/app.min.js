/*! map 09-12-2014 */

var Viewer={};Viewer.Scene=function(a){this.parentContainer=$("#"+a.containerId),this.container=document.getElementById(a.canvasId),this.jqContainer=$("#"+a.canvasId),this.context=a.context,this.WIDTH=this.container.width,this.HEIGHT=this.container.height,this.wrangler=null,this.scene=null,this.projector=null,this.renderer=null,this.setup=null,this.cameras=null,this.controls=null,this.raycaster=null,this.init()},Viewer.Scene.prototype={init:function(){var a={context:this};this.scene=new THREE.Scene,this.projector=new THREE.Projector,this.renderer=new THREE.WebGLRenderer({canvas:this.container,antialias:!0}),this.wrangler=new Viewer.Wrangler(a),this.setup=new Viewer.Scene.Setup(a),this.cameras=new Viewer.Scene.Cameras(a),this.controls=new THREE.OrbitControls(this.cameras.liveCam,this.container),this.raycaster=new THREE.Raycaster,this.wrangler.init(),this.listeners()},listeners:function(){var a=null;window.addEventListener("resize",function(){a&&clearTimeout(a),a=setTimeout(function(){this.onWindowResize()}.bind(this),100)}.bind(this),!1)},onWindowResize:function(){this.WIDTH=window.innerWidth,this.HEIGHT=window.innerHeight,this.cameras.liveCam.aspect=this.WIDTH/this.HEIGHT,this.cameras.liveCam.updateProjectionMatrix(),this.renderer.setSize(this.WIDTH,this.HEIGHT),this.renderer.setViewport(0,0,this.WIDTH,this.HEIGHT)}},Viewer.Scene=Viewer.Scene||{},Viewer.Scene.Setup=function(a){this.context=a.context,this.axisHelper=null,this.WIDTH=this.context.container.clientWidth,this.HEIGHT=this.context.container.clientHeight,this.init()},Viewer.Scene.Setup.prototype={init:function(){this.setupRenderer(),this.lights(),this.createGeometry(),SETUP.SCENE.HELPERS&&this.helpers()},helpers:function(){this.axisHelper=new THREE.AxisHelper(SETUP.SCENE.AXIS_LENGTH),this.axisHelper.position.setZ(5),this.axisHelper.name="axishelper",this.context.scene.add(this.axisHelper)},setupRenderer:function(){this.context.renderer.setSize(this.WIDTH,this.HEIGHT),this.context.renderer.setViewport(0,0,this.WIDTH,this.HEIGHT),this.context.jqContainer.fadeIn()},lights:function(){var a=new THREE.DirectionalLight(14540253);a.position.set(0,-1,1).normalize(),a.name="light",this.context.scene.add(a);var b=new THREE.SpotLight(16777215,1);b.position.set(-300,600,300),b.target.position.set(0,0,0),b.name="light",this.context.scene.add(b);var c=new THREE.AmbientLight(4473924);c.name="ambient",this.context.scene.add(c);var d=new THREE.DirectionalLight(16772829);d.position.set(0,0,1).normalize(),c.name="dl2",this.context.scene.add(d)},createGeometry:function(){SETUP.SCENE.GROUND&&this.createGround(),SETUP.SCENE.GRID&&this.createGrid()},createGrid:function(){for(var a=100,b=10,c=new THREE.Geometry,d=new THREE.LineBasicMaterial({color:"black"}),e=-a;a>=e;e+=b)c.vertices.push(new THREE.Vector3(-a,.04,e)),c.vertices.push(new THREE.Vector3(a,.04,e)),c.vertices.push(new THREE.Vector3(e,.04,-a)),c.vertices.push(new THREE.Vector3(e,.04,a));var f=new THREE.Line(c,d,THREE.LinePieces);f.name="grid",this.context.scene.add(f)},createGround:function(){var a,b=new THREE.MeshPhongMaterial({color:16777215,ambient:8947848,shading:THREE.SmoothShading});a=new THREE.Mesh(new THREE.PlaneGeometry(1024,1024),b),a.rotation.x=-Math.PI/2,a.name="ground",this.context.scene.add(a)}},Viewer.Util={randomHex:function(){return("000000"+Math.floor(16777215*Math.random()).toString(16)).slice(-6)},changeColor:function(a){var b=parseInt("0x"+this.randomHex(),16);a.object.material.color.setHex(b)},randomColor:function(){return parseInt("0x"+this.randomHex(),16)},randomInt:function(a,b){return Math.floor(Math.random()*(a-b+1))+b},supportsWebGL:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}},Viewer.Scene=Viewer.Scene||{},Viewer.Scene.Cameras=function(a){this.context=a.context,this.liveCam=null,this.FOV=SETUP.CAM.FOV||70,this.WIDTH=this.context.container.clientWidth,this.HEIGHT=this.context.container.clientHeight,this.VIEWSIZE=SETUP.CAM.VIEWSIZE||1e3,this.ASPECT_RATIO=this.WIDTH/this.HEIGHT,this.ORTHO_CAMERA=SETUP.CAM.ORTHO?!0:!1,this.perpCam=null,this.PERP_NEAR_PLANE=SETUP.CAM.PERP_NEAR_PLANE||1,this.PERP_FAR_PLANE=SETUP.CAM.PERP_FAR_PLANE||1e4,this.orthCam=null,this.ORTH_NEAR_PLANE=SETUP.CAM.ORTH_NEAR_PLANE||-1e3,this.ORTH_FAR_PLANE=SETUP.CAM.ORTH_FAR_PLANE||1e3,this.controls=null,this.init()},Viewer.Scene.Cameras.prototype={init:function(){this.ORTHO_CAMERA?this.initOrthographicCamera():this.initPerspective()},initOrthographicCamera:function(){this.orthoCam=new THREE.OrthographicCamera(-this.ASPECT_RATIO*this.VIEWSIZE/2,this.ASPECT_RATIO*this.VIEWSIZE/2,this.VIEWSIZE/2,this.VIEWSIZE/-2,this.ORTH_NEAR_PLANE,this.ORTH_FAR_PLANE),this.orthoCam.name="ortho",this.liveCam=this.orthoCam},initPerspective:function(){this.perpCam=new THREE.PerspectiveCamera(this.FOV,this.ASPECT_RATIO,this.PERP_NEAR_PLANE,this.PERP_FAR_PLANE),this.perpCam.position.y=100,this.perpCam.position.z=400,this.perpCam.lookAt(this.context.scene.position),this.perpCam.name="perp",this.liveCam=this.perpCam}},Viewer.Wrangler=Viewer.Wrangler||{},Viewer.Wrangler=function(a){this.context=a.context,this.currentModel=null,this.loadingManager=new THREE.LoadingManager,this.objMtlLoader=new THREE.OBJMTLLoader(this.loadingManager),this.objLoader=new THREE.OBJLoader(this.loadingManager),this.imgLoader=new THREE.ImageLoader(this.loadingManager),this.glTFLoader=new THREE.glTFLoader,this.jsLoader=new THREE.JSONLoader,this.name=null,this.imgFiles={}},Viewer.Wrangler.prototype={init:function(){THREE.Loader.Handlers.add(/\.dds$/i,new THREE.DDSLoader),this.listeners(),this.loadDefaultFiles()},listeners:function(){this.loadingManager.onProgress=function(a,b,c){}},loadDefaultFiles:function(){var a=SETUP.SAMPLES.GRIDTEXTURE;this.loadNormalTexture(a)},loadJSON:function(a,b){this.removeFromScene(),this.name=b,this.jsLoader.load(a,function(a,c){var d=new THREE.Mesh(a,new THREE.MeshFaceMaterial(c));d.rotation.x=-Math.PI/2,d.position.y+=50,d.name=b,this.currentModel=d,this.context.scene.add(d)}.bind(this))},loadOBJ:function(a,b){this.removeFromScene(),this.name=b,this.objLoader.load(a,function(a){var c;c=this.imgFiles[b]?this.imgFiles[b]:this.imgFiles.grid,a.traverse(function(a){a instanceof THREE.Mesh&&(a.material.map=c)}),a.name=b,this.currentModel=a,this.context.scene.add(a)}.bind(this))},loadOBJMTL:function(a,b,c){this.removeFromScene(),this.name=c,this.objMtlLoader.load(a,b,function(a){a.name=c,this.currentModel=a,this.context.scene.add(a)}.bind(this))},loadGLTF:function(a,b){this.removeFromScene(),this.name=b,this.glTFLoader.load(a,function(a){a.scene.name=b,this.currentModel=a.scene,this.context.scene.add(a.scene)}.bind(this))},loadNormalTexture:function(a){var b=new THREE.Texture;this.imgLoader.load(a,function(a){b.image=a,b.needsUpdate=!0,this.imgFiles.grid=b}.bind(this))},removeFromScene:function(){var a=this.context.scene.getObjectByName(this.name,!0);this.context.scene.remove(a)}};var SETUP={CAM:{ORTH_NEAR_PLANE:-1e3,ORTH_FAR_PLANE:1e3,PERP_NEAR_PLANE:1,PERP_FAR_PLANE:1e4,FOV:70,ORTHO:!1,VIEWSIZE:1e3},SCENE:{HELPERS:!0,AXIS_LENGTH:50,GRID:!0,GROUND:!0},LIGHTS:{DIRECTIONAL:!0,SPOT:!0,AMBIENT:!0},DEBUG_MODE:!1,SAMPLES:{GLTFURL:"/v1/dist/gltf/duck.json",GLTFNAME:"glTF_Duck",JSONURL:"/v1/dist/js/female.js",JSONNAME:"Textured_Lady",OBJURL:"/v1/dist/obj/male02.obj",MTLURL:"/v1/dist/obj/male02.mtl",OBJNAME:"No_Texture_Guy",OBJMTLNAME:"Textured_Guy",GRIDTEXTURE:"/v2/dist/obj/UV_Grid_Sm.jpg"},LOAD_DELAY:1500},ThreeViewer=angular.module("ThreeViewer",["ngHammer","ngRoute","LocalStorageModule"]).config(["localStorageServiceProvider",function(a){a.setPrefix("ng-three-viewer")}]).config(["$locationProvider",function(a){a.html5Mode(!0)}]).config(["$routeProvider",function(a){var b=function(){return window.chrome};a.when("/",{templateUrl:b()?"/v1/dist/partials/chrome.html":"/v1/dist/partials/bad-time.html",controller:"AppController"}).otherwise({redirectTo:"/"})}]);ThreeViewer.controller("AppController",["$scope","ViewerFactory",function(a,b){b.init({canvasId:"viewer",containerId:"container"}),a.tb={about:!1,visible:!0,loader:!0},a.data={scale:1,rotateX:0,rotateY:0,rotateZ:0,positionX:0,positionY:0,positionZ:0},a.toggleLoader=function(){this.tb.about=!1,this.tb.loader=!this.tb.loader},a.hideAbout=function(){this.tb.about=!1},a.toggleToolbar=function(){this.tb.about=!1,this.tb.visible=!this.tb.visible},a.showAbout=function(){this.tb.loader=!1,this.tb.visible=!1,this.tb.about=!0},a.hideLoader=function(){this.tb.loader=!1},a.hideToolbar=function(){this.tb.visible=!1},a.scale=function(){b.scale(this.data.scale)},a.rotate=function(){b.rotate(parseFloat(this.data.rotateX),parseFloat(this.data.rotateY),parseFloat(this.data.rotateZ))},a.translate=function(){b.translate(parseFloat(this.data.positionX),parseFloat(this.data.positionY),parseFloat(this.data.positionZ))},a.$on("hideLoader",function(){a.tb.loader=!1})}]),ThreeViewer.directive("select",["ViewerFactory",function(a){return{restrict:"A",link:function(b,c){var d,e,f,g,h,i,j={};$(c).hammer({prevent_default:!1}).bind("tap",function(b){d=b.gesture.center.x,e=b.gesture.center.y,h=c.context.offsetLeft,i=c.context.offsetTop,f=window.innerWidth,g=window.innerHeight,j.x=d/f*2-1,j.y=2*-(e/g)+1,a.makeSelection(j)})}}}]).directive("fileLoader",function(){return{restrict:"A",templateUrl:"/v1/dist/partials/file-loader.html"}}).directive("toolbars",function(){return{restrict:"A",templateUrl:"/v1/dist/partials/toolbar.html"}}).directive("about",function(){return{restrict:"A",templateUrl:"/v1/dist/partials/about.html"}}).directive("stopEvent",function(){return{restrict:"A",link:function(a,b){b.on("click",function(a){a.stopImmediatePropagation(),a.preventDefault()})}}}),ThreeViewer.controller("FileLoaderController",["$scope","MessageBus","ViewerFactory","StorageService",function(a,b,c,d){function e(){a.data.obj=null,a.data.mtl=null,a.data.name=null,a.data.url=null,a.data.gltfname=null,a.data.scale=1,a.data.yOffset=0,a.data.zOffset=0,a.data.jsurl=null,a.data.jsname=null,a.data.selectedModel=a.data.recent[0]}function f(){a.data.recent=d.getAllFiles()}function g(){var a={obj:SETUP.SAMPLES.OBJURL,mtl:SETUP.SAMPLES.MTLURL,name:SETUP.SAMPLES.OBJMTLNAME,type:"objmtl"};c.loadOBJMTL(a),d.saveFile(a)}a.firstTime=!0,a.state={recent:!0,loadJS:!1,loadGLTF:!1,loadOBJ:!1},a.data={selectedModel:null,recent:d.getAllFiles(),obj:null,mtl:null,name:null,url:null,gltfname:null,jsurl:null,jsname:null},a.showTab=function(a){this.state.recent=!1,this.state.loadJS=!1,this.state.loadGLTF=!1,this.state.loadOBJ=!1,this.state[a]=!0},a.loadSelectedFile=function(){var a=this.data.selectedModel;"obj"==a.type?(this.data.obj=a.obj,this.data.name=a.name,this.loadOBJ()):"objmtl"==a.type?(this.data.obj=a.obj,this.data.mtl=a.mtl,this.data.name=a.name,this.loadOBJMTL()):"JSON"==a.type?(this.data.jsurl=a.url,this.data.jsname=a.name,this.loadJSON()):"glTF"==a.type&&(this.data.url=a.url,this.data.gltfname=a.name,this.loadglTF()),b.trigger("hideLoader")},a.loadOBJ=function(){if(this.data.obj&&this.data.name){var a={obj:this.data.obj,name:this.data.name,type:"obj"};c.loadOBJ(a),d.saveFile(a),e(),b.trigger("hideLoader")}else alert("need obj url and a name")},a.loadSampleOBJ=function(){this.data.obj=SETUP.SAMPLES.OBJURL,this.data.name=SETUP.SAMPLES.OBJNAME,this.loadOBJ()},a.loadOBJMTL=function(){if(this.data.obj&&this.data.mtl&&this.data.name){var a={obj:this.data.obj,mtl:this.data.mtl,name:this.data.name,type:"objmtl"};c.loadOBJMTL(a),d.saveFile(a),b.trigger("hideLoader"),e()}else alert("need obj, mtl and name")},a.loadSampleOBJMTL=function(){this.data.obj=SETUP.SAMPLES.OBJURL,this.data.mtl=SETUP.SAMPLES.MTLURL,this.data.name=SETUP.SAMPLES.OBJMTLNAME,this.loadOBJMTL()},a.loadglTF=function(){if(this.data.url&&this.data.gltfname){var a={url:this.data.url,name:this.data.gltfname,type:"glTF"};c.loadGLTF(a),d.saveFile(a),e(),b.trigger("hideLoader")}else alert("URL to a glTF file and a unique name required")},a.loadSampleglTF=function(){this.data.url=SETUP.SAMPLES.GLTFURL,this.data.gltfname=SETUP.SAMPLES.GLTFNAME,this.loadglTF()},a.loadJSON=function(){if(this.data.jsurl&&this.data.jsname){var a={url:this.data.jsurl,name:this.data.jsname,type:"JSON"};c.loadJSON(a),d.saveFile(a),e(),b.trigger("hideLoader")}else alert("URL to a JSON file and a unique name required")},a.loadSampleJSON=function(){this.data.jsurl=SETUP.SAMPLES.JSONURL,this.data.jsname=SETUP.SAMPLES.JSONNAME,this.loadJSON()},a.clearRecent=function(){d.clear()},a.$on("updatedHistory",function(){f()}),a.$on("appReady",function(){g()})}]),ThreeViewer.filter("forceInt",function(){return function(a){return parseInt(a,10)}}).filter("forceFloat",function(){return function(a){return parseFloat(a)}}),ThreeViewer.service("MessageBus",["$rootScope",function(a){this.message={},this.trigger=function(a,b){this.message[a]=b,this.broadcast(a)},this.broadcast=function(b){a.$broadcast(b)}}]),ThreeViewer.service("StorageService",["localStorageService","MessageBus",function(a,b){this.getFileInfo=function(b){return a.get(b)},this.clear=function(){a.clearAll(),b.trigger("updatedHistory")},this.getNames=function(){var b=a.get("models");return"[object Array]"===Object.prototype.toString.call(b)?b:[]},this.getAllFiles=function(){for(var a=this.getNames(),b=[{file:"No recent files",type:!1}],c=0;c<a.length;c++)b.push(this.getFileInfo(a[c]));return b[0].type===!1&&b.length>1&&b.shift(),b},this.saveFile=function(c){var d=this.getNames();-1==d.indexOf(c.name)&&(d.push(c.name),a.set("models",d),a.set(c.name,c)),b.trigger("updatedHistory"),b.trigger("showLoader")}}]),ThreeViewer.factory("ViewerFactory",["$timeout","MessageBus",function(a,b){function c(c){n=new Viewer.Scene(c),a(function(){b.trigger("appReady")},SETUP.LOAD_DELAY),d()}function d(){requestAnimationFrame(d),e()}function e(){n.renderer.render(n.scene,n.cameras.liveCam),n.controls.update()}function f(a){var c=new THREE.Vector3(a.x,a.y,1).unproject(n.cameras.liveCam);n.raycaster.set(n.cameras.liveCam.position,c.sub(n.cameras.liveCam.position).normalize());var d=n.raycaster.intersectObjects(n.wrangler.collision,!0);d.length>0?(d=d[0],b.trigger("objectSelected",d[0])):d=null}function g(a){n.wrangler.loadOBJMTL(a.obj,a.mtl,a.name)}function h(a){n.wrangler.loadOBJ(a.obj,a.name)}function i(a){n.wrangler.loadGLTF(a.url,a.name)}function j(a){n.wrangler.loadJSON(a.url,a.name)}function k(a,b,c){n.wrangler.currentModel.rotation.set(THREE.Math.degToRad(a),THREE.Math.degToRad(b),THREE.Math.degToRad(c))}function l(a,b,c){n.wrangler.currentModel.position.set(a,b,c)}function m(a){n.wrangler.currentModel.scale.set(a,a,a)}var n;return{init:c,makeSelection:f,loadOBJMTL:g,loadGLTF:i,loadOBJ:h,loadJSON:j,scale:m,translate:l,rotate:k}}]);
//# sourceMappingURL=app.min.map